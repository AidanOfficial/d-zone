#syntax=docker/dockerfile:1.0

# base image
FROM node:16 as base

# copies the same monorepo structure as host
# excluding unrequired workspaces
WORKDIR /d-zone
COPY .yarn .yarn
COPY package.json .yarnrc.yml yarn.lock ./
COPY ./packages/common ./packages/common
COPY ./packages/server ./packages/server

# install all the dependencies
RUN yarn

# development
FROM base as development
WORKDIR /d-zone/packages/server
CMD ["yarn", "dev"]

# production build
# builder stage
FROM base as builder
WORKDIR /d-zone/packages/server
RUN yarn build

# production install
RUN yarn prod-install /d-zone-temp/build/server
RUN cp -r dist /d-zone-temp/build/server/dist

# copy the built package from build
FROM node:16 as production
WORKDIR /server
COPY --from=builder /d-zone-temp/build/server .
COPY ./packages/server/*.env .
CMD ["yarn", "start"]
